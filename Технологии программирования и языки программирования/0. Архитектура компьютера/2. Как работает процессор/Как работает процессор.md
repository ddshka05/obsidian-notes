### Процессоры
Всего есть две компании которые выпускают процессоры: Intel, AMD. Существует множество процессоров на любой вкус и цвет.  У них у всех есть определенный набор команд, что вызывает проблемы (кто как хочет, так и ворочает).

Имеется две проблемы в архитектуре процессоров:
- обратная совместимость (чтобы фичи прошлых дженов были доступны на новых процессорах)
- поддержание языков программирования (все процессоры должны уметь работать со всеми языками программирования)

То есть надо решить проблему единой трансляции в машинный код. Процессоры должны поддерживать единую архитектуру, для которой будут писать компиляторы. 

Примеры архитектур: 
1. х86 (персональные компы, сервера)
2. ARM (телефоны и планшеты)
3. ARM (микроконтроллеры встроенных систем - телевизоры)

Будем говорить про х86. Сюда входит семейство Intel 8086 и далее. 

Все процессоры определяются разрядностью. **Разрядность** - это величина машинного слова. **Машинное слово** - это максимальное количество бит, которым может оперировать компьютер за раз. Разрядность отражает то, какой максимально адрес байта в памяти может хранить процессор. Это отражает и максимальный объём используемой памяти.

![[Pasted image 20250702140721.png]]

Первые процессоры могли адресоваться к 64 КБ адресов (в реальности 1 Мб памяти, потому что логический адрес так работает, см. чуть ниже). Далее интеловские процессоры стали 32 разрядными, что позволило обращаться к памяти до 4 Мб. Именно их и назвали х86. 

Далее разработали 64 разрядные процессоры. Они были с полной обратной совместимостью. Они стали называться x86-64. 

Интел долго не могли стоять в стороне и они хотели создать свою архитектуру для расширения до 64 битных целых чисел. Но это бы привело к проблемам с архитектурой и совместимостью программ в связи с отсутствием стандартизацией. Они лицензировали у AMD технологию AMD64 с некоторыми изменениями. Но они считайте одно и то же. 
### Как работает процессор
Он работает постоянно, пока включен компьютер. 

Чтобы что-то считать ему нужна память. Для этого у процессора есть регистровая память и кэш-память. 

Регистры - самая быстрая память. Операции с такой памятью выполняются быстрее всего. 

Максимальный размер регистра равен разрядности процессора, то есть зависит от технологии. Например, 16-разрядные регистры кодируются 16 битами каждый. 

Также регистр должен быть кратен ячейке оперативной памяти, чтобы корректно считывать инструкции и данные из памяти. Есть два основных вида адресации (байтовая и словесная). 

Пусть у нас байтовая адресация. Пусть у нас регистр 32 бита = 4 байта. 

### Регистры
Всего регистры бывают двух видов:
- регистры специального назначения
- регистры общего назначения (переменные, параметры, хранилище промежуточных значений)
#### Регистры общего назначения
Тут у нас есть прикол с историей развития архитектуры х86. Регистры стали похоже на матрешку. 

![[Pasted image 20250702142429.png]]
#### Регистры специального назначения
Содержат для конкретных содержимых. IP тоже там)

![[Pasted image 20250702142536.png]]

Тут про знаковое переполнение.

Про язык ассемблера. 

Процессор читает инструкции в регистр. Инструкции или опкод (mov ax - это опкод, а 7 - это данные). 

### Что происходит, когда включается компьютер
Процессор начинает выполнять команды по жестко-фиксированному адресу. По этому адресу располагается BIOS (basic output input system, её задача найти первое дисковое устройство, которое было указано ранее, загрузить первый сектор в память и передать ему управление, то есть указать процессору на то, чтобы он начал выполнять инструкции загруженной программы). 

Эта программа называется операционной системой, она переводит процессор в защищенный режим, организуется работа с памятью. 

Далее после запуска какой-либо программы после запуска компьютера ОС выделяет память, загружает в оперативную память, передает ей управление (с какого места процессору надо выполнить программу) 
### Режимы работы процессора
Адреса, из которых процессор должен брать информацию выставляются программами в ходе их работы. Но если бы они могли обратиться в любое место памяти, то тогда бы это вызывало большие проблемы с безопасностью. 

Поэтому тот адрес, который выставляет программа и реальный адрес ячейки в памяти могут сильно отличаться. Это **механизм трансляции адресов**

Нужно для понимания этого сначала разобраться с режимом работы процессора:

![[Pasted image 20250702144309.png]]
1. Это 16 битный режим, он переходит в него сразу после включения. Адрес сформированный программами является реальным и не требует преобразований.
2. Защищенный режим (можно перейти только из реж. реальных адресов) - означает что обеспечивается защищенность данных операционной системы от прикладных программ, и данных программ друг от друга. Это достигается путем выставления уровня привилегий программ. После запуска ОС она переводит процессор в защищенный режим, выставляя специальный флаг системного регистра, устанавливает разрешения. ОС становится хозяином компьютера. Процессор следит за тем, чтобы правила не переопределялись. Если нарушаются правила, управление программой переводится ОС и она уже решает, что с ней делать.
3. Такой же защищенный.
Реальные классификации чуть отличаются.
### Уровни привилегий 
Это доступ к использованию ресурсов процессора. В режим. реальных адресов нет, потому что может выполняться только одна программа одновременно, поэтому данные не надо защищать ни от кого.

В других режимах работы процессора имеются 4 уровня привилегий (от 0 до 3):
- 0 уровень (привилегированный) - на нём работает ОС
- 1 уровень (менее привилегированный) - запреты установленные на 0 уровне действуют на 1 уровень.
- 2 уровень
- 3 уровень (пользовательский) - имеет самый низкий приоритет. На нем работают прикладные программы. 

![[Pasted image 20250702145245.png]]

В основном используются только два уровня привилегий 0 и 3 уровень.
### Как устроена память в разные режимы работы процессора

Можно поговорить про устройство адресации. Вся память поделена на сегменты - это отдельные участки памяти, которые поделены на сегменты. Их размер зависит от режима процессора.

Программы предоставляют адрес в виде логического адреса. 
![[Pasted image 20250702151112.png]]

В режиме реальных адресов, память делится на сегменты по 64 Кб. В нем числа, это 16-битные числа. Физический адрес тогда исчисляется так:
![[Pasted image 20250702151314.png]]

Сдвигается адрес начала сегмента на 4 бита, прибавляется смещение. Максимум мы можем заадрессовать 1 Мб физической памяти.

В защищенном режиме память делится на сегменты от 0 до 4 Гб. Операционная система представляет, что программа обладает всем адресным пространством. В этом режиме активируется механизм трансляции виртуальных адресов в физический адрес. То есть программы работают в виртуальном адресном пространстве, о котором они не догадываются. Прикладные программы все так же формируют логические адреса, предполагая, что они обращаются к физическим адресам.

Теперь формируются адреса так:

![[Pasted image 20250702151839.png]]

16-битный селектор дескриптора определяется уровнем прив. таблицей и индексом, которые берется из дескрипторных таблиц

![[Pasted image 20250702152103.png]] 

Вот такая схема. 
